var detailview=$.extend({},$.fn.datagrid.defaults.view,{render:function(K,E,A){var D=$.data(K,"datagrid");var B=D.options;if(A){if(!(B.rownumbers||(B.frozenColumns&&B.frozenColumns.length))){return}}var O=D.data.rows;var J=$(K).datagrid("getColumnFields",A);var M=[];M.push('<table class="datagrid-btable" cellspacing="0" cellpadding="0" border="0"><tbody>');for(var H=0;H<O.length;H++){var I=B.rowStyler?B.rowStyler.call(K,H,O[H]):"";var F="";var N="";if(typeof I=="string"){N=I}else{if(I){F=I["class"]||"";N=I.style||""}}var L='class="datagrid-row '+(H%2&&B.striped?"datagrid-row-alt ":" ")+F+'"';var C=N?'style="'+N+'"':"";var G=D.rowIdPrefix+"-"+(A?1:2)+"-"+H;M.push('<tr id="'+G+'" datagrid-row-index="'+H+'" '+L+" "+C+">");M.push(this.renderRow.call(this,K,J,A,H,O[H]));M.push("</tr>");M.push('<tr style="display:none;">');if(A){M.push("<td colspan="+(J.length+(B.rownumbers?1:0))+' style="border-right:0">')}else{M.push("<td colspan="+(J.length)+">")}M.push('<div class="datagrid-row-detail">');if(A){M.push("&nbsp;")}else{M.push(B.detailFormatter.call(K,H,O[H]))}M.push("</div>");M.push("</td>");M.push("</tr>")}M.push("</tbody></table>");$(E).html(M.join(""))},renderRow:function(L,K,A,M,H){var B=$.data(L,"datagrid").options;var G=[];if(A&&B.rownumbers){var F=M+1;if(B.pagination){F+=(B.pageNumber-1)*B.pageSize}G.push('<td class="datagrid-td-rownumber"><div class="datagrid-cell-rownumber">'+F+"</div></td>")}for(var I=0;I<K.length;I++){var N=K[I];var E=$(L).datagrid("getColumnOption",N);if(E){var O=H[N];var J=E.styler?(E.styler(O,H,M)||""):"";var D="";var Q="";if(typeof J=="string"){Q=J}else{if(G){D=J["class"]||"";Q=J.style||""}}var P=D?'class="'+D+'"':"";var C=E.hidden?'style="display:none;'+Q+'"':(Q?'style="'+Q+'"':"");G.push('<td field="'+N+'" '+P+" "+C+">");if(E.checkbox){C=""}else{if(E.expander){C="text-align:center;height:16px;"}else{C=Q;if(E.align){C+=";text-align:"+E.align+";"}if(!B.nowrap){C+=";white-space:normal;height:auto;"}else{if(B.autoRowHeight){C+=";height:auto;"}}}}G.push('<div style="'+C+'" ');if(E.checkbox){G.push('class="datagrid-cell-check ')}else{G.push('class="datagrid-cell '+E.cellClass)}G.push('">');if(E.checkbox){G.push('<input type="checkbox" name="'+N+'" value="'+(O!=undefined?O:"")+'">')}else{if(E.expander){G.push('<span class="datagrid-row-expander datagrid-row-expand" style="display:inline-block;width:16px;height:16px;cursor:pointer;" />')}else{if(E.formatter){G.push(E.formatter(O,H,M))}else{G.push(O)}}}G.push("</div>");G.push("</td>")}}return G.join("")},insertRow:function(F,E,K){var A=$.data(F,"datagrid").options;var J=$.data(F,"datagrid").dc;var B=$(F).datagrid("getPanel");var I=J.view1;var G=J.view2;var H=false;var C=$(F).datagrid("getRows").length;if(C==0){$(F).datagrid("loadData",{total:1,rows:[K]});return}if(E==undefined||E==null||E>=C){E=C;H=true;this.canUpdateDetail=false}$.fn.datagrid.defaults.view.insertRow.call(this,F,E,K);D(true);D(false);this.canUpdateDetail=true;function D(O){var L=O?I:G;var N=L.find("tr[datagrid-row-index="+E+"]");if(H){var M=N.next().clone();N.insertAfter(N.next())}else{var M=N.next().next().clone()}M.insertAfter(N);M.hide();if(!O){M.find("div.datagrid-row-detail").html(A.detailFormatter.call(F,E,K))}}},deleteRow:function(E,B){var C=$.data(E,"datagrid").options;var A=$.data(E,"datagrid").dc;var D=C.finder.getTr(E,B);D.next().remove();$.fn.datagrid.defaults.view.deleteRow.call(this,E,B);A.body2.triggerHandler("scroll")},updateRow:function(E,G,F){var B=$.data(E,"datagrid").dc;var D=$.data(E,"datagrid").options;var A=$(E).datagrid("getExpander",G).attr("class");$.fn.datagrid.defaults.view.updateRow.call(this,E,G,F);$(E).datagrid("getExpander",G).attr("class",A);if(this.canUpdateDetail){var F=$(E).datagrid("getRows")[G];var C=$(E).datagrid("getRowDetail",G);C.html(D.detailFormatter.call(E,G,F))}},bindEvents:function(E){var D=$.data(E,"datagrid");if(D.ss.bindDetailEvents){return}D.ss.bindDetailEvents=true;var B=D.dc;var C=D.options;var A=B.body1.add(B.body2);var F=($.data(A[0],"events")||$._data(A[0],"events")).click[0].handler;A.unbind("click").bind("click",function(I){var G=$(I.target);var H=G.closest("tr.datagrid-row");if(!H.length){return}if(G.hasClass("datagrid-row-expander")){var J=parseInt(H.attr("datagrid-row-index"));if(G.hasClass("datagrid-row-expand")){$(E).datagrid("expandRow",J)}else{$(E).datagrid("collapseRow",J)}$(E).datagrid("fixRowHeight")}else{F(I)}I.stopPropagation()})},onBeforeRender:function(G){var B=$.data(G,"datagrid");var A=B.options;var H=B.dc;var I=$(G);var J=false;var F=I.datagrid("getColumnFields",true).concat(I.datagrid("getColumnFields"));for(var E=0;E<F.length;E++){var C=I.datagrid("getColumnOption",F[E]);if(C.expander){J=true;break}}if(!J){if(A.frozenColumns&&A.frozenColumns.length){A.frozenColumns[0].splice(0,0,{field:"_expander",expander:true,width:24,resizable:false,fixed:true})}else{A.frozenColumns=[[{field:"_expander",expander:true,width:24,resizable:false,fixed:true}]]}var I=H.view1.children("div.datagrid-header").find("table");var D=$('<td rowspan="'+A.frozenColumns.length+'"><div class="datagrid-header-expander" style="width:24px;"></div></td>');if($("tr",I).length==0){D.wrap("<tr></tr>").parent().appendTo($("tbody",I))}else{if(A.rownumbers){D.insertAfter(I.find("td:has(div.datagrid-header-rownumber)"))}else{D.prependTo(I.find("tr:first"))}}}},onAfterRender:function(G){var F=this;var C=$.data(G,"datagrid");var I=C.dc;var A=C.options;var B=$(G).datagrid("getPanel");$.fn.datagrid.defaults.view.onAfterRender.call(this,G);if(!C.onResizeColumn){C.onResizeColumn=A.onResizeColumn}if(!C.onResize){C.onResize=A.onResize}function D(){var K=I.header2.find("table");var J=K.find("tr.datagrid-filter-row").hide();var M=K.width()-1;var L=I.body2.find(">table.datagrid-btable>tbody>tr>td>div.datagrid-row-detail:visible")._outerWidth(M);L.find(".easyui-fluid").trigger("_resize");J.show()}A.onResizeColumn=function(M,L){if(!A.fitColumns){D()}var J=$(G).datagrid("getRows").length;for(var K=0;K<J;K++){$(G).datagrid("fixDetailRowHeight",K)}C.onResizeColumn.call(G,M,L)};A.onResize=function(K,J){if(A.fitColumns){D()}C.onResize.call(B,K,J)};this.canUpdateDetail=true;var H=I.footer1.add(I.footer2);H.find("span.datagrid-row-expander").css("visibility","hidden");$(G).datagrid("resize");this.bindEvents(G);var E=I.body1.add(I.body2).find("div.datagrid-row-detail");E.unbind().bind("mouseover mouseout click dblclick contextmenu scroll",function(J){J.stopPropagation()})}});$.extend($.fn.datagrid.methods,{fixDetailRowHeight:function(B,A){return B.each(function(){var F=$.data(this,"datagrid").options;if(!(F.rownumbers||(F.frozenColumns&&F.frozenColumns.length))){return}var E=$.data(this,"datagrid").dc;var D=F.finder.getTr(this,A,"body",1).next();var G=F.finder.getTr(this,A,"body",2).next();if(G.is(":visible")){D.css("height","");G.css("height","");var C=Math.max(D.height(),G.height());D.css("height",C);G.css("height",C)}E.body2.triggerHandler("scroll")})},getExpander:function(C,A){var B=$.data(C[0],"datagrid").options;return B.finder.getTr(C[0],A).find("span.datagrid-row-expander")},getRowDetail:function(D,A){var B=$.data(D[0],"datagrid").options;var C=B.finder.getTr(D[0],A,"body",2);return C.next().find(">td>div.datagrid-row-detail")},expandRow:function(B,A){return B.each(function(){var E=$(this).datagrid("options");var D=$.data(this,"datagrid").dc;var H=$(this).datagrid("getExpander",A);if(H.hasClass("datagrid-row-expand")){H.removeClass("datagrid-row-expand").addClass("datagrid-row-collapse");var C=E.finder.getTr(this,A,"body",1).next();var G=E.finder.getTr(this,A,"body",2).next();C.show();G.show();$(this).datagrid("fixDetailRowHeight",A);if(E.onExpandRow){var F=$(this).datagrid("getRows")[A];E.onExpandRow.call(this,A,F)}}})},collapseRow:function(B,A){return B.each(function(){var E=$(this).datagrid("options");var D=$.data(this,"datagrid").dc;var H=$(this).datagrid("getExpander",A);if(H.hasClass("datagrid-row-collapse")){H.removeClass("datagrid-row-collapse").addClass("datagrid-row-expand");var C=E.finder.getTr(this,A,"body",1).next();var G=E.finder.getTr(this,A,"body",2).next();C.hide();G.hide();D.body2.triggerHandler("scroll");if(E.onCollapseRow){var F=$(this).datagrid("getRows")[A];E.onCollapseRow.call(this,A,F)}}})}});$.extend($.fn.datagrid.methods,{subgrid:function(B,A){return B.each(function(){E(this,A);function E(J,H,G){var I=$.extend({},H.options.queryParams||{});I[H.options.foreignField]=G?G[H.options.foreignValue]:undefined;$(J).datagrid($.extend({},H.options,{subgrid:H.subgrid,view:(H.subgrid?detailview:undefined),queryParams:I,detailFormatter:function(K,L){return'<div><table class="datagrid-subgrid"></table></div>'},onExpandRow:function(K,O){var M=$(this).datagrid("options");var L=$(this).datagrid("getRowDetail",K);var N=F(L);if(!N.data("datagrid")){E(N[0],M.subgrid,O)}L.find(".easyui-fluid").trigger("_resize");C(this,K);if(H.options.onExpandRow){H.options.onExpandRow.call(this,K,O)}},onCollapseRow:function(K,L){C(this,K);if(H.options.onCollapseRow){H.options.onCollapseRow.call(this,K,L)}},onResize:function(){var K=$(this).children("div.datagrid-view").children("table");D(this)},onResizeColumn:function(L,K){D(this);if(H.options.onResizeColumn){H.options.onResizeColumn.call(this,L,K)}},onLoadSuccess:function(K){D(this);if(H.options.onLoadSuccess){H.options.onLoadSuccess.call(this,K)}}}))}function F(G){var H=$(G).children("div");if(H.children("div.datagrid").length){return H.find(">div.datagrid>div.panel-body>div.datagrid-view>table.datagrid-subgrid")}else{return H.find(">table.datagrid-subgrid")}}function D(J){var H=$(J).closest("div.datagrid-row-detail").closest("tr").prev();if(H.length){var G=parseInt(H.attr("datagrid-row-index"));var I=H.closest("div.datagrid-view").children("table");C(I[0],G)}}function C(J,G){$(J).datagrid("fixDetailRowHeight",G);$(J).datagrid("fixRowHeight",G);var H=$(J).closest("div.datagrid-row-detail").closest("tr").prev();if(H.length){var G=parseInt(H.attr("datagrid-row-index"));var I=H.closest("div.datagrid-view").children("table");C(I[0],G)}}})}});
