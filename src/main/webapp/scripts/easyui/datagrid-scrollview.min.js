$.extend($.fn.datagrid.defaults,{rowHeight:25,onBeforeFetch:function(A){},onFetch:function(B,A){},loader:function(D,C,A){var B=$(this).datagrid("options");if(!B.url){return false}if(B.view.type=="scrollview"){D.page=D.page||1;D.rows=D.rows||B.pageSize}$.ajax({type:B.method,url:B.url,data:D,dataType:"json",success:function(E){C(E)},error:function(){A.apply(this,arguments)}})}});var scrollview=$.extend({},$.fn.datagrid.defaults.view,{type:"scrollview",render:function(L,E,A){var D=$.data(L,"datagrid");var B=D.options;var P=this.rows||[];if(!P.length){return}var J=$(L).datagrid("getColumnFields",A);if(A){if(!(B.rownumbers||(B.frozenColumns&&B.frozenColumns.length))){return}}var K=this.index;var N=['<div class="datagrid-btable-top"></div>','<table class="datagrid-btable" cellspacing="0" cellpadding="0" border="0"><tbody>'];for(var H=0;H<P.length;H++){var I=B.rowStyler?B.rowStyler.call(L,K,P[H]):"";var F="";var O="";if(typeof I=="string"){O=I}else{if(I){F=I["class"]||"";O=I.style||""}}var M='class="datagrid-row '+(K%2&&B.striped?"datagrid-row-alt ":" ")+F+'"';var C=O?'style="'+O+'"':"";var G=D.rowIdPrefix+"-"+(A?1:2)+"-"+K;N.push('<tr id="'+G+'" datagrid-row-index="'+K+'" '+M+" "+C+">");N.push(this.renderRow.call(this,L,J,A,K,P[H]));N.push("</tr>");if(B.detailFormatter){N.push('<tr style="display:none;">');if(A){N.push("<td colspan="+(J.length+(B.rownumbers?1:0))+' style="border-right:0">')}else{N.push("<td colspan="+(J.length)+">")}N.push('<div class="datagrid-row-detail">');if(A){N.push("&nbsp;")}else{N.push(B.detailFormatter.call(L,K,P[H]))}N.push("</div>");N.push("</td>");N.push("</tr>")}K++}N.push("</tbody></table>");N.push('<div class="datagrid-btable-bottom"></div>');$(E).html(N.join(""))},renderRow:function(L,K,A,M,H){var B=$.data(L,"datagrid").options;var G=[];if(A&&B.rownumbers){var F=M+1;if(B.pagination){F+=(B.pageNumber-1)*B.pageSize}G.push('<td class="datagrid-td-rownumber"><div class="datagrid-cell-rownumber">'+F+"</div></td>")}for(var I=0;I<K.length;I++){var N=K[I];var E=$(L).datagrid("getColumnOption",N);if(E){var O=H[N];var J=E.styler?(E.styler(O,H,M)||""):"";var D="";var Q="";if(typeof J=="string"){Q=J}else{if(G){D=J["class"]||"";Q=J.style||""}}var P=D?'class="'+D+'"':"";var C=E.hidden?'style="display:none;'+Q+'"':(Q?'style="'+Q+'"':"");G.push('<td field="'+N+'" '+P+" "+C+">");if(E.checkbox){C=""}else{if(E.expander){C="text-align:center;height:16px;"}else{C=Q;if(E.align){C+=";text-align:"+E.align+";"}if(!B.nowrap){C+=";white-space:normal;height:auto;"}else{if(B.autoRowHeight){C+=";height:auto;"}}}}G.push('<div style="'+C+'" ');if(E.checkbox){G.push('class="datagrid-cell-check ')}else{G.push('class="datagrid-cell '+E.cellClass)}G.push('">');if(E.checkbox){G.push('<input type="checkbox" name="'+N+'" value="'+(O!=undefined?O:"")+'">')}else{if(E.expander){G.push('<span class="datagrid-row-expander datagrid-row-expand" style="display:inline-block;width:16px;height:16px;cursor:pointer;" />')}else{if(E.formatter){G.push(E.formatter(O,H,M))}else{G.push(O)}}}G.push("</div>");G.push("</td>")}}return G.join("")},bindEvents:function(E){var D=$.data(E,"datagrid");var B=D.dc;var C=D.options;var A=B.body1.add(B.body2);var F=($.data(A[0],"events")||$._data(A[0],"events")).click[0].handler;A.unbind("click").bind("click",function(I){var G=$(I.target);var H=G.closest("tr.datagrid-row");if(!H.length){return}if(G.hasClass("datagrid-row-expander")){var J=parseInt(H.attr("datagrid-row-index"));if(G.hasClass("datagrid-row-expand")){$(E).datagrid("expandRow",J)}else{$(E).datagrid("collapseRow",J)}$(E).datagrid("fixRowHeight")}else{F(I)}I.stopPropagation()})},onBeforeRender:function(G){var E=$.data(G,"datagrid");var D=E.options;var B=E.dc;var A=this;E.data.firstRows=E.data.rows;E.data.rows=[];D.finder=$.extend({},$.fn.datagrid.defaults.finder,{getRow:function(K,L){var J=(typeof L=="object")?L.attr("datagrid-row-index"):L;var M=$.data(K,"datagrid").data.rows[J];if(!M){var I=$(K).datagrid("options").view;M=I.rows[J-I.index]}return M}});B.body1.add(B.body2).empty();this.rows=[];this.r1=this.r2=[];H();C();function H(){E.onLoadSuccess=D.onLoadSuccess;D.onLoadSuccess=function(){};setTimeout(function(){B.body2.unbind(".datagrid").bind("scroll.datagrid",function(I){if(E.onLoadSuccess){D.onLoadSuccess=E.onLoadSuccess;E.onLoadSuccess=undefined}if(A.scrollTimer){clearTimeout(A.scrollTimer)}A.scrollTimer=setTimeout(function(){F.call(A)},50)});B.body2.triggerHandler("scroll.datagrid")},0)}function F(){if(!D.finder.getRows(G).length){M.call(this)}else{if(!B.body2.is(":visible")){return}var J=B.view2.children("div.datagrid-header").outerHeight();var L=B.body2.children("div.datagrid-btable-top");var I=B.body2.children("div.datagrid-btable-bottom");if(!L.length||!I.length){return}var O=L.position().top+L._outerHeight()-J;var K=I.position().top-J;if(O>B.body2.height()||K<0){M.call(this)}else{if(O>0){var N=Math.floor(this.index/D.pageSize);this.getRows.call(this,G,N,function(P){this.r2=this.r1;this.r1=P;this.index=(N-1)*D.pageSize;this.rows=this.r1.concat(this.r2);this.populate.call(this,G)})}else{if(K<B.body2.height()){if(E.data.rows.length>=E.data.total){return}var N=Math.floor(this.index/D.pageSize)+2;if(this.r2.length){N++}this.getRows.call(this,G,N,function(P){if(!this.r2.length){this.r2=P}else{this.r1=this.r2;this.r2=P;this.index+=D.pageSize}this.rows=this.r1.concat(this.r2);this.populate.call(this,G)})}}}}function M(){var R=$(B.body2).scrollTop();var P=Math.floor(R/D.rowHeight);var Q=Math.floor(P/D.pageSize)+1;this.getRows.call(this,G,Q,function(S){this.index=(Q-1)*D.pageSize;this.rows=S;this.r1=S;this.r2=[];this.populate.call(this,G);B.body2.triggerHandler("scroll.datagrid")})}}function C(){if(!D.detailFormatter){return}var L=$(G);var M=false;var I=L.datagrid("getColumnFields",true).concat(L.datagrid("getColumnFields"));for(var K=0;K<I.length;K++){var J=L.datagrid("getColumnOption",I[K]);if(J.expander){M=true;break}}if(!M){if(D.frozenColumns&&D.frozenColumns.length){D.frozenColumns[0].splice(0,0,{field:"_expander",expander:true,width:24,resizable:false,fixed:true})}else{D.frozenColumns=[[{field:"_expander",expander:true,width:24,resizable:false,fixed:true}]]}var L=B.view1.children("div.datagrid-header").find("table");var N=$('<td rowspan="'+D.frozenColumns.length+'"><div class="datagrid-header-expander" style="width:24px;"></div></td>');if($("tr",L).length==0){N.wrap("<tr></tr>").parent().appendTo($("tbody",L))}else{if(D.rownumbers){N.insertAfter(L.find("td:has(div.datagrid-header-rownumber)"))}else{N.prependTo(L.find("tr:first"))}}}setTimeout(function(){A.bindEvents(G)},0)}},onAfterRender:function(B){$.fn.datagrid.defaults.view.onAfterRender.call(this,B);var A=$.data(B,"datagrid").dc;var C=A.footer1.add(A.footer2);C.find("span.datagrid-row-expander").css("visibility","hidden")},getRows:function(E,F,G){var B=$.data(E,"datagrid");var A=B.options;var D=(F-1)*A.pageSize;if(A.onBeforeFetch.call(E,F)==false){return}var I=B.data.firstRows.slice(D,D+A.pageSize);if(I.length){A.onFetch.call(E,F,I);G.call(this,I)}else{var C=$.extend({},A.queryParams,{page:F,rows:A.pageSize});if(A.sortName){$.extend(C,{sort:A.sortName,order:A.sortOrder})}if(A.onBeforeLoad.call(E,C)==false){return}$(E).datagrid("loading");var H=A.loader.call(E,C,function(J){$(E).datagrid("loaded");var J=A.loadFilter.call(E,J);A.onFetch.call(E,F,J.rows);if(J.rows&&J.rows.length){G.call(A.view,J.rows)}else{A.onLoadSuccess.call(E,J)}},function(){$(E).datagrid("loaded");A.onLoadError.apply(E,arguments)});if(H==false){$(E).datagrid("loaded");if(!B.data.firstRows.length){A.onFetch.call(E,F,B.data.firstRows);A.onLoadSuccess.call(E,B.data)}}}},populate:function(G){var D=$.data(G,"datagrid");var A=D.options;var I=D.dc;var B=A.rowHeight;if(this.rows.length){A.view.render.call(A.view,G,I.body2,false);A.view.render.call(A.view,G,I.body1,true);var F=I.body1.add(I.body2);F.children("div.datagrid-btable-top").css("height",this.index*B);F.children("div.datagrid-btable-bottom").css("height",D.data.total*B-this.rows.length*B-this.index*B);var C=[];for(var E=0;E<this.index;E++){C.push({})}D.data.rows=C.concat(this.rows);var H=I.body2.scrollTop();$(G).datagrid("setSelectionState");I.body2.scrollTop(H);A.onLoadSuccess.call(G,{total:D.data.total,rows:this.rows})}},insertRow:function(D,A,E){var C=$.data(D,"datagrid");var B=C.data;if(A==undefined||A==null){A=B.rows.length}if(A>B.rows.length){A=B.rows.length}$.fn.datagrid.defaults.view.insertRow.call(this,D,A,E);if(B.firstRows&&A<B.firstRows.length){B.firstRows.splice(A,0,E)}},deleteRow:function(C,A){var B=$(C).datagrid("getData");$.fn.datagrid.defaults.view.deleteRow.call(this,C,A);if(B.firstRows){B.firstRows.splice(A,1)}}});$.fn.datagrid.methods.baseScrollTo=$.fn.datagrid.methods.scrollTo;$.extend($.fn.datagrid.methods,{gotoPage:function(B,A){return B.each(function(){var E=this;var C=$(E).datagrid("options");var D,F;if(typeof A=="object"){D=A.page;F=A.callback}else{D=A}C.view.getRows.call(C.view,E,D,function(G){this.index=(D-1)*C.pageSize;this.rows=G;this.r1=G;this.r2=[];this.populate.call(this,E);$(E).data("datagrid").dc.body2.scrollTop(this.index*C.rowHeight);if(F){F.call(E,D)}})})},scrollTo:function(B,A){return B.each(function(){var G=this;var E=$(G).datagrid("options");var D,H;if(typeof A=="object"){D=A.index;H=A.callback}else{D=A}var C=E.view;if(C.type=="scrollview"){if(D>=C.index&&D<C.index+C.rows.length){$(G).datagrid("baseScrollTo",D);if(H){H.call(G,D)}}else{if(D>=0){var F=Math.floor(D/E.pageSize)+1;$(G).datagrid("gotoPage",{page:F,callback:function(){setTimeout(function(){$(G).datagrid("baseScrollTo",D);if(H){H.call(G,D)}},0)}})}}}else{$(G).datagrid("baseScrollTo",D);if(H){H.call(G,D)}}})}});$.extend($.fn.datagrid.methods,{fixDetailRowHeight:function(B,A){return B.each(function(){var F=$.data(this,"datagrid").options;var E=$.data(this,"datagrid").dc;var D=F.finder.getTr(this,A,"body",1).next();var G=F.finder.getTr(this,A,"body",2).next();if(G.is(":visible")){D.css("height","");G.css("height","");var C=Math.max(D.height(),G.height());D.css("height",C);G.css("height",C)}E.body2.triggerHandler("scroll")})},getExpander:function(C,A){var B=$.data(C[0],"datagrid").options;return B.finder.getTr(C[0],A).find("span.datagrid-row-expander")},getRowDetail:function(D,A){var B=$.data(D[0],"datagrid").options;var C=B.finder.getTr(D[0],A,"body",2);return C.next().find("div.datagrid-row-detail")},expandRow:function(B,A){return B.each(function(){var E=$(this).datagrid("options");var D=$.data(this,"datagrid").dc;var H=$(this).datagrid("getExpander",A);if(H.hasClass("datagrid-row-expand")){H.removeClass("datagrid-row-expand").addClass("datagrid-row-collapse");var C=E.finder.getTr(this,A,"body",1).next();var G=E.finder.getTr(this,A,"body",2).next();C.show();G.show();$(this).datagrid("fixDetailRowHeight",A);if(E.onExpandRow){var F=$(this).datagrid("getRows")[A];E.onExpandRow.call(this,A,F)}}})},collapseRow:function(B,A){return B.each(function(){var E=$(this).datagrid("options");var D=$.data(this,"datagrid").dc;var H=$(this).datagrid("getExpander",A);if(H.hasClass("datagrid-row-collapse")){H.removeClass("datagrid-row-collapse").addClass("datagrid-row-expand");var C=E.finder.getTr(this,A,"body",1).next();var G=E.finder.getTr(this,A,"body",2).next();C.hide();G.hide();D.body2.triggerHandler("scroll");if(E.onCollapseRow){var F=$(this).datagrid("getRows")[A];E.onCollapseRow.call(this,A,F)}}})}});
