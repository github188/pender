$.extend($.fn.datagrid.defaults,{groupHeight:25,expanderWidth:30});var groupview=$.extend({},$.fn.datagrid.defaults.view,{render:function(F,B,E){var D=[];var A=this.groups;for(var C=0;C<A.length;C++){D.push(this.renderGroup.call(this,F,C,A[C],E))}$(B).html(D.join(""))},renderGroup:function(K,M,L,A){var D=$.data(K,"datagrid");var B=D.options;var I=$(K).datagrid("getColumnFields",A);if(A){if(!(B.rownumbers||(B.frozenColumns&&B.frozenColumns.length))){return""}}var O=[];O.push('<div class="datagrid-group" group-index='+M+">");if((A&&(B.rownumbers||B.frozenColumns.length))||(!A&&!(B.rownumbers||B.frozenColumns.length))){O.push('<span class="datagrid-group-expander">');O.push('<span class="datagrid-row-expander datagrid-row-collapse">&nbsp;</span>');O.push("</span>")}if(!A){O.push('<span class="datagrid-group-title">');O.push(B.groupFormatter.call(K,L.value,L.rows));O.push("</span>")}O.push("</div>");O.push('<table class="datagrid-btable" cellspacing="0" cellpadding="0" border="0"><tbody>');var J=L.startIndex;for(var G=0;G<L.rows.length;G++){var H=B.rowStyler?B.rowStyler.call(K,J,L.rows[G]):"";var E="";var P="";if(typeof H=="string"){P=H}else{if(H){E=H["class"]||"";P=H.style||""}}var N='class="datagrid-row '+(J%2&&B.striped?"datagrid-row-alt ":" ")+E+'"';var C=P?'style="'+P+'"':"";var F=D.rowIdPrefix+"-"+(A?1:2)+"-"+J;O.push('<tr id="'+F+'" datagrid-row-index="'+J+'" '+N+" "+C+">");O.push(this.renderRow.call(this,K,I,A,J,L.rows[G]));O.push("</tr>");J++}O.push("</tbody></table>");return O.join("")},bindEvents:function(D){var C=$.data(D,"datagrid");var B=C.dc;var A=B.body1.add(B.body2);var E=($.data(A[0],"events")||$._data(A[0],"events")).click[0].handler;A.unbind("click").bind("click",function(H){var G=$(H.target);var I=G.closest("span.datagrid-row-expander");if(I.length){var F=I.closest("div.datagrid-group").attr("group-index");if(I.hasClass("datagrid-row-collapse")){$(D).datagrid("collapseGroup",F)}else{$(D).datagrid("expandGroup",F)}}else{E(H)}H.stopPropagation()})},onBeforeRender:function(I,M){var B=$.data(I,"datagrid");var A=B.options;J();var C=[];for(var E=0;E<M.length;E++){var L=M[E];var K=D(L[A.groupField]);if(!K){K={value:L[A.groupField],rows:[L]};C.push(K)}else{K.rows.push(L)}}var H=0;var G=[];for(var E=0;E<C.length;E++){var K=C[E];K.startIndex=H;H+=K.rows.length;G=G.concat(K.rows)}B.data.rows=G;this.groups=C;var F=this;setTimeout(function(){F.bindEvents(I)},0);function D(O){for(var N=0;N<C.length;N++){var P=C[N];if(P.value==O){return P}}return null}function J(){if(!$("#datagrid-group-style").length){$("head").append('<style id="datagrid-group-style">.datagrid-group{height:'+A.groupHeight+"px;overflow:hidden;font-weight:bold;border-bottom:1px solid #ccc;}.datagrid-group-title,.datagrid-group-expander{display:inline-block;vertical-align:bottom;height:100%;line-height:"+A.groupHeight+"px;padding:0 4px;}.datagrid-group-expander{width:"+A.expanderWidth+"px;text-align:center;padding:0}.datagrid-row-expander{margin:"+Math.floor((A.groupHeight-16)/2)+"px 0;display:inline-block;width:16px;height:16px;cursor:pointer}</style>")}}}});$.extend($.fn.datagrid.methods,{groups:function(A){return A.datagrid("options").view.groups},expandGroup:function(B,A){return B.each(function(){var C=$.data(this,"datagrid").dc.view;var D=C.find(A!=undefined?'div.datagrid-group[group-index="'+A+'"]':"div.datagrid-group");var E=D.find("span.datagrid-row-expander");if(E.hasClass("datagrid-row-expand")){E.removeClass("datagrid-row-expand").addClass("datagrid-row-collapse");D.next("table").show()}$(this).datagrid("fixRowHeight")})},collapseGroup:function(B,A){return B.each(function(){var C=$.data(this,"datagrid").dc.view;var D=C.find(A!=undefined?'div.datagrid-group[group-index="'+A+'"]':"div.datagrid-group");var E=D.find("span.datagrid-row-expander");if(E.hasClass("datagrid-row-collapse")){E.removeClass("datagrid-row-collapse").addClass("datagrid-row-expand");D.next("table").hide()}$(this).datagrid("fixRowHeight")})}});$.extend(groupview,{refreshGroupTitle:function(G,E){var D=$.data(G,"datagrid");var C=D.options;var A=D.dc;var F=this.groups[E];var B=A.body2.children("div.datagrid-group[group-index="+E+"]").find("span.datagrid-group-title");B.html(C.groupFormatter.call(G,F.value,F.rows))},insertRow:function(F,E,J){var B=$.data(F,"datagrid");var A=B.options;var I=B.dc;var G=null;var H;if(!B.data.rows.length){$(F).datagrid("loadData",[J]);return}for(var D=0;D<this.groups.length;D++){if(this.groups[D].value==J[A.groupField]){G=this.groups[D];H=D;break}}if(G){if(E==undefined||E==null){E=B.data.rows.length}if(E<G.startIndex){E=G.startIndex}else{if(E>G.startIndex+G.rows.length){E=G.startIndex+G.rows.length}}$.fn.datagrid.defaults.view.insertRow.call(this,F,E,J);if(E>=G.startIndex+G.rows.length){C(E,true);C(E,false)}G.rows.splice(E-G.startIndex,0,J)}else{G={value:J[A.groupField],rows:[J],startIndex:B.data.rows.length};H=this.groups.length;I.body1.append(this.renderGroup.call(this,F,H,G,true));I.body2.append(this.renderGroup.call(this,F,H,G,false));this.groups.push(G);B.data.rows.push(J)}this.refreshGroupTitle(F,H);function C(K,O){var M=O?1:2;var L=A.finder.getTr(F,K-1,"body",M);var N=A.finder.getTr(F,K,"body",M);N.insertAfter(L)}},updateRow:function(E,B,F){var C=$.data(E,"datagrid").options;$.fn.datagrid.defaults.view.updateRow.call(this,E,B,F);var A=C.finder.getTr(E,B,"body",2).closest("table.datagrid-btable");var D=parseInt(A.prev().attr("group-index"));this.refreshGroupTitle(E,D)},deleteRow:function(G,F){var B=$.data(G,"datagrid");var A=B.options;var J=B.dc;var E=J.body1.add(J.body2);var C=A.finder.getTr(G,F,"body",2).closest("table.datagrid-btable");var I=parseInt(C.prev().attr("group-index"));$.fn.datagrid.defaults.view.deleteRow.call(this,G,F);var H=this.groups[I];if(H.rows.length>1){H.rows.splice(F-H.startIndex,1);this.refreshGroupTitle(G,I)}else{E.children("div.datagrid-group[group-index="+I+"]").remove();for(var D=I+1;D<this.groups.length;D++){E.children("div.datagrid-group[group-index="+D+"]").attr("group-index",D-1)}this.groups.splice(I,1)}var F=0;for(var D=0;D<this.groups.length;D++){var H=this.groups[D];H.startIndex=F;F+=H.rows.length}}});
